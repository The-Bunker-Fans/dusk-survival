using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Content.Shared.CartridgeLoader.Cartridges;
using Content.Client.GameTicking.Managers;

namespace Content.Client.CartridgeLoader.Cartridges;

[GenerateTypedNameReferences]
public sealed partial class MessagesUiFragment : BoxContainer
{

    public event Action<string>? OnMessageSent;
    public event Action<int?>? OnButtonPressed;

    public MessagesUiFragment()
    {
        RobustXamlLoader.Load(this);
        Orientation = LayoutOrientation.Vertical;
        HorizontalExpand = true;
        VerticalExpand = true;

        Input.OnTextEntered += _ =>
        {
            if (!string.IsNullOrEmpty(Input.Text))
                OnMessageSent?.Invoke(Input.Text);
            Input.Clear();
        };

        HeaderButton.OnPressed += _ => OnButtonPressed?.Invoke(null);

        UpdateState(MessagesUiStateMode.UserList, [], null);
    }

    public void UpdateState(MessagesUiStateMode mode, List<(string, int?)>? contents, string? name)
    {
        MessageContainer.DisposeAllChildren();
        if (OverContainer.Children.Contains(Input))
            OverContainer.RemoveChild(Input);
        if (OverContainer.Children.Contains(HeaderBox))
            OverContainer.RemoveChild(HeaderBox);
        if (mode == MessagesUiStateMode.Chat && contents != null)
        {
            HeaderLabel.Text = name;

            foreach (var (senderName, message) in contents)
            {
                AddNote($"{senderName} {message}");
            }

            OverContainer.AddChild(Input);
            OverContainer.AddChild(HeaderBox);
        }
        else
        {
            if (contents == null)
            {
                return;
            }
            foreach (var (user, userUid) in contents)
            {
                AddButton(userUid, user);
            }
        }
    }

    private void AddButton(int? userUid, string userName)
    {
        var button = new Button
        {
            Text = userName,
            HorizontalExpand = true,
            ClipText = true,
            MinWidth = 60
        };
        button.OnPressed += _ => OnButtonPressed?.Invoke(userUid);
        MessageContainer.AddChild(button);
    }

    private void AddNote(string note)
    {
        MessageContainer.AddChild(new Label
        {
            Text = note,
            HorizontalExpand = true,
            ClipText = false
        });
    }
}
